name: Build Talos Image with Incus Agent

on:
  workflow_dispatch:
    inputs:
      talos_version:
        description: "Talos Linux version"
        required: true
        default: "v1.12.4"
      arch:
        description: "Architecture"
        required: true
        default: "amd64"
        type: choice
        options:
          - amd64
          - arm64
      extension_version:
        description: "Extension image tag"
        required: true
        default: "6.22.0"

env:
  REGISTRY: ghcr.io
  EXTENSION_IMAGE: ghcr.io/aredan/talos-incus-agent:${{ inputs.extension_version }}

jobs:
  build-installer:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build installer image with incus-agent extension
        run: |
          mkdir -p /tmp/talos-out
          docker run --rm --privileged \
            -v /tmp/talos-out:/out \
            -v /var/run/docker.sock:/var/run/docker.sock \
            ghcr.io/siderolabs/imager:${{ inputs.talos_version }} \
            installer \
            --arch ${{ inputs.arch }} \
            --system-extension-image ${{ env.EXTENSION_IMAGE }}

      - name: Install crane
        run: |
          VERSION=0.20.2
          curl -sL "https://github.com/google/go-containerregistry/releases/download/v${VERSION}/go-containerregistry_Linux_x86_64.tar.gz" | tar -xzf - crane
          sudo mv crane /usr/local/bin/

      - name: Push installer image to GHCR
        run: |
          crane push /tmp/talos-out/installer-${{ inputs.arch }}.tar ${{ env.REGISTRY }}/aredan/talos-installer:${{ inputs.talos_version }}-incus-agent

  build-metal:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Talos metal image with incus-agent extension
        run: |
          mkdir -p /tmp/talos-out
          docker run --rm --privileged \
            -v /dev:/dev \
            -v /tmp/talos-out:/out \
            -v /var/run/docker.sock:/var/run/docker.sock \
            ghcr.io/siderolabs/imager:${{ inputs.talos_version }} \
            metal \
            --arch ${{ inputs.arch }} \
            --system-extension-image ${{ env.EXTENSION_IMAGE }}

      - name: Convert to Incus-compatible format
        run: |
          sudo apt-get update && sudo apt-get install -y qemu-utils zstd

          # Decompress
          zstd -d /tmp/talos-out/metal-${{ inputs.arch }}.raw.zst

          # Convert raw to qcow2
          qemu-img convert -p -f raw -O qcow2 \
            /tmp/talos-out/metal-${{ inputs.arch }}.raw \
            /tmp/talos-out/rootfs.img

          # Create Incus metadata
          cat > /tmp/talos-out/metadata.yaml <<EOF
          architecture: x86_64
          creation_date: $(date +%s)
          properties:
            description: Talos Linux ${{ inputs.talos_version }} with incus-agent
            os: Talos Linux
            release: ${{ inputs.talos_version }}
          EOF

          # Package as tar.zst for incus image import
          tar --zstd -cf /tmp/talos-out/talos-${{ inputs.talos_version }}-incus-agent-${{ inputs.arch }}.tar.zst \
            -C /tmp/talos-out metadata.yaml rootfs.img

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: talos-${{ inputs.talos_version }}-incus-agent-${{ inputs.arch }}
          path: /tmp/talos-out/talos-${{ inputs.talos_version }}-incus-agent-${{ inputs.arch }}.tar.zst
          retention-days: 30
